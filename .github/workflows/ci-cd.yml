name: CI/CD Pipeline

# ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì •ì˜
on:
  push:
    branches: [ main, master ]  # main ë˜ëŠ” master ë¸Œëœì¹˜ì— pushë  ë•Œ
  pull_request:
    branches: [ main, master ]  # PRì´ ìƒì„±ë  ë•Œ
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  DOCKER_IMAGE_NAME: newplayerkor/nginx-cicd
  DOCKER_IMAGE_TAG: ${{ github.sha }}

# ì‘ì—… ì •ì˜
jobs:
  # 1ë‹¨ê³„: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    # Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
    
    # Docker ì´ë¯¸ì§€ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ìš©)
    - name: ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        echo "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:test .
        echo "ë¹Œë“œ ì™„ë£Œ!"
    
    # ë¹Œë“œëœ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
    - name: ğŸ§ª ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
      run: |
        echo "ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸..."
        # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
        docker run -d --name test-container -p 8080:80 ${{ env.DOCKER_IMAGE_NAME }}:test
        
        # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        sleep 10
        
        # í—¬ìŠ¤ì²´í¬
        echo "í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰..."
        curl -f http://localhost:8080/health || exit 1
        
        # HTTP ì‘ë‹µ í™•ì¸
        echo "HTTP ì‘ë‹µ í™•ì¸..."
        curl -s http://localhost:8080 | grep "CI/CD" || exit 1
        
        # ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
        docker stop test-container
        docker rm test-container
        
        echo "ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! âœ…"

  # 2ë‹¨ê³„: Docker Hubì— ë°°í¬ (main ë¸Œëœì¹˜ì—ë§Œ)
  deploy:
    needs: build-and-test  # build-and-test ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    # ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    # Docker Buildx ì„¤ì •
    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
    
    # Docker Hub ë¡œê·¸ì¸
    - name: ğŸ” Docker Hub ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    # ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (íƒœê·¸, ë¼ë²¨ ë“±)
    - name: ğŸ·ï¸ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: ğŸš€ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "Docker Hub: https://hub.docker.com/r/${{ env.DOCKER_IMAGE_NAME }}"
        echo "íƒœê·¸: ${{ steps.meta.outputs.tags }}"